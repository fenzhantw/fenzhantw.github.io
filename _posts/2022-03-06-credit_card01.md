---
title: "[BasicML] Credit Card Fault Detection ì‹¤ìŠµ 01"
excerpt: "Kaggle,Fault Detection,LightGBM"
categories:
    - BasicML

tag:
    - python
    - machine learning

author_profile: true    #ì‘ì„±ì í”„ë¡œí•„ ì¶œë ¥ ì—¬ë¶€

toc: true   #Table Of Contents ëª©ì°¨ 
toc_sticky: true
---
```
ğŸŒœ ì´ ë¬¸ì„œì— ë‚˜ì˜¤ëŠ” ìë£Œì™€ ë°ì´í„°ëŠ” ê¶Œì² ë¯¼ ì €ì˜ ë¨¸ì‹ ëŸ¬ë‹ ì™„ë²½ê°€ì´ë“œì™€ ì¸í”„ëŸ°ì˜ ê°•ì˜ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì •ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤.
ì˜¤ë¥˜ë‚˜ í‹€ë¦° ë¶€ë¶„ì´ ìˆì„ ê²½ìš° ì–¸ì œë“ ì§€ ëŒ“ê¸€ í˜¹ì€ ë©”ì¼ë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”! ğŸ˜„
```

#### Credit Card Fault Detection ì‹¤ìŠµ 01

- https://www.kaggle.com/mlg-ulb/creditcardfraud

ì¹´ë“œì‚¬ê°€ ì¹´ë“œ ì‚¬ê¸°ê±´ì„ ê²€ì¶œ ë° ë°©ì§€í•˜ëŠ” ê²ƒì€ ê³ ê°ì´ êµ¬ë§¤í•˜ì§€ ì•ŠëŠ” ë¬¼ê±´ì— ëŒ€í•´ ë¹„ìš©ì„ ì§€ë¶ˆí•˜ì§€ ì•Šë„ë¡ í•˜ê¸° ìœ„í•œ ë§¤ìš° ì¤‘ìš”í•œ ì‘ì—…ì„. ë”°ë¼ì„œ ì´ëŸ¬í•œ Faultë¥¼ ê°ì§€í•˜ê¸° ìœ„í•œ ML ëª¨ë¸ì„ ì‹¤ìŠµì„ í†µí•´ êµ¬ì¶•í•´ë³´ê³ , ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•´ë´„

##### ë°ì´í„° í˜¸ì¶œ

```python
import pandas as pd
import numpy as np 
import matplotlib.pyplot as plt
import warnings
warnings.filterwarnings("ignore")
%matplotlib inline

card_df = pd.read_csv('./creditcard.csv')
card_df.head(3)
```

| Time |   V1 |        V2 |        V3 |       V4 |       V5 |        V6 |        V7 |        V8 |       V9 |       ... |  V21 |       V22 |       V23 |       V24 |       V25 |       V26 |       V27 |       V28 |    Amount |  Class |      |
| ---: | ---: | --------: | --------: | -------: | -------: | --------: | --------: | --------: | -------: | --------: | ---: | --------: | --------: | --------: | --------: | --------: | --------: | --------: | --------: | -----: | ---- |
|    0 |  0.0 | -1.359807 | -0.072781 | 2.536347 | 1.378155 | -0.338321 |  0.462388 |  0.239599 | 0.098698 |  0.363787 |  ... | -0.018307 |  0.277838 | -0.110474 |  0.066928 |  0.128539 | -0.189115 |  0.133558 | -0.021053 | 149.62 | 0    |
|    1 |  0.0 |  1.191857 |  0.266151 | 0.166480 | 0.448154 |  0.060018 | -0.082361 | -0.078803 | 0.085102 | -0.255425 |  ... | -0.225775 | -0.638672 |  0.101288 | -0.339846 |  0.167170 |  0.125895 | -0.008983 |  0.014724 |   2.69 | 0    |
|    2 |  1.0 | -1.358354 | -1.340163 | 1.773209 | 0.379780 | -0.503198 |  1.800499 |  0.791461 | 0.247676 | -1.514654 |  ... |  0.247998 |  0.771679 |  0.909412 | -0.689281 | -0.327642 | -0.139097 | -0.055353 | -0.059752 | 378.66 | 0    |



ë°ì´í„°ë¥¼ í™•ì¸í•´ë³´ë©´, V1,V2...V28ê¹Œì§€ ìˆëŠ”ë°, ì´ëŠ” PCAë¥¼ í†µí•´ ì–»ëŠ” ê²°ê³¼ì´ë©° AmountëŠ” ì¹´ë“œ ì‚¬ìš©ì•¡ì´ë‹¤. Classì— 0ì€ ì •ìƒ, 1ì€ ë¹„ì •ìƒ ì‚¬ìš©ì•¡ì´ë‹¤.

Kaggleì˜ ì„¤ëª…ì„ ë³´ë©´, ê°œì¸ì •ë³´ ë•Œë¬¸ì— ê°œì¸ì„ íŠ¹ì •í•  ìˆ˜ ìˆëŠ” ì‹ ìš©ì •ë³´ ë°ì´í„°ë¥¼ ê°€ê³µí•˜ì—¬ ì œê³µí•œë‹¤ê³  ë‚˜ì™€ìˆë‹¤.

##### ë°ì´í„° ê°€ê³µ

```python
from sklearn.model_selection import train_test_split

# ì¸ìë¡œ ì…ë ¥ë°›ì€ DataFrameì„ ë³µì‚¬ í•œ ë’¤ Time ì»¬ëŸ¼ë§Œ ì‚­ì œí•˜ê³  ë³µì‚¬ëœ DataFrame ë°˜í™˜
def get_preprocessed_df(df=None):
    df_copy = df.copy()
    df_copy.drop('Time', axis=1, inplace=True)
    return df_copy

# ì‚¬ì „ ë°ì´í„° ê°€ê³µ í›„ í•™ìŠµê³¼ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì„¸íŠ¸ë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜.
def get_train_test_dataset(df=None):
    # ì¸ìë¡œ ì…ë ¥ëœ DataFrameì˜ ì‚¬ì „ ë°ì´í„° ê°€ê³µì´ ì™„ë£Œëœ ë³µì‚¬ DataFrame ë°˜í™˜
    df_copy = get_preprocessed_df(df)
    
    # DataFrameì˜ ë§¨ ë§ˆì§€ë§‰ ì»¬ëŸ¼ì´ ë ˆì´ë¸”, ë‚˜ë¨¸ì§€ëŠ” í”¼ì²˜ë“¤
    X_features = df_copy.iloc[:, :-1]
    y_target = df_copy.iloc[:, -1]
    
    # train_test_split( )ìœ¼ë¡œ í•™ìŠµê³¼ í…ŒìŠ¤íŠ¸ ë°ì´í„° ë¶„í• . stratify=y_targetìœ¼ë¡œ Stratified ê¸°ë°˜ ë¶„í• 
    X_train, X_test, y_train, y_test = \
    train_test_split(X_features, y_target, test_size=0.3, random_state=0, stratify=y_target)
    
    # í•™ìŠµê³¼ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì„¸íŠ¸ ë°˜í™˜
    return X_train, X_test, y_train, y_test

X_train, X_test, y_train, y_test = get_train_test_dataset(card_df)
```

train_test_split APIì—ì„œ stratifyë¥¼ í™œìš©í•˜ë©´, íƒ€ê²Ÿê°’ì˜ ë¶„í¬ë„ì— ë”°ë¼ì„œ í•™ìŠµê³¼ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ë§ì¶°ì„œ ë¶„í• í•´ì¤Œ. ì•„ë˜ì—ì„œ í™•ì¸í•´ë³´ì.

```
print('í•™ìŠµ ë°ì´í„° ë ˆì´ë¸” ê°’ ë¹„ìœ¨')
print(y_train.value_counts()/y_train.shape[0] * 100)
print('í…ŒìŠ¤íŠ¸ ë°ì´í„° ë ˆì´ë¸” ê°’ ë¹„ìœ¨')
print(y_test.value_counts()/y_test.shape[0] * 100)
```

```
í•™ìŠµ ë°ì´í„° ë ˆì´ë¸” ê°’ ë¹„ìœ¨
0    99.827451
1     0.172549
Name: Class, dtype: float64
í…ŒìŠ¤íŠ¸ ë°ì´í„° ë ˆì´ë¸” ê°’ ë¹„ìœ¨
0    99.826785
1     0.173215
Name: Class, dtype: float64
```

##### í‰ê°€ì§€í‘œ í•¨ìˆ˜ 

```python
from sklearn.metrics import confusion_matrix, accuracy_score, precision_score, recall_score, f1_score
from sklearn.metrics import roc_auc_score

# ìˆ˜ì •ëœ get_clf_eval() í•¨ìˆ˜ 
def get_clf_eval(y_test, pred=None, pred_proba=None):
    confusion = confusion_matrix( y_test, pred)
    accuracy = accuracy_score(y_test , pred)
    precision = precision_score(y_test , pred)
    recall = recall_score(y_test , pred)
    f1 = f1_score(y_test,pred)
    # ROC-AUC ì¶”ê°€ 
    roc_auc = roc_auc_score(y_test, pred_proba)
    print('ì˜¤ì°¨ í–‰ë ¬')
    print(confusion)
    # ROC-AUC print ì¶”ê°€
    print('ì •í™•ë„: {0:.4f}, ì •ë°€ë„: {1:.4f}, ì¬í˜„ìœ¨: {2:.4f},\
    F1: {3:.4f}, AUC:{4:.4f}'.format(accuracy, precision, recall, f1, roc_auc))
```

##### ëª¨ë¸ ë° í‰ê°€ì§€í‘œ í™•ì¸(ë¡œì§€ìŠ¤í‹± íšŒê·€)

```python
from sklearn.linear_model import LogisticRegression

lr_clf = LogisticRegression()

lr_clf.fit(X_train, y_train)

lr_pred = lr_clf.predict(X_test)
lr_pred_proba = lr_clf.predict_proba(X_test)[:, 1]

# 3ì¥ì—ì„œ ì‚¬ìš©í•œ get_clf_eval() í•¨ìˆ˜ë¥¼ ì´ìš©í•˜ì—¬ í‰ê°€ ìˆ˜í–‰. 
get_clf_eval(y_test, lr_pred, lr_pred_proba)

```

```
ì˜¤ì°¨ í–‰ë ¬
[[85279    16]
 [   60    88]]
ì •í™•ë„: 0.9991, ì •ë°€ë„: 0.8462, ì¬í˜„ìœ¨: 0.5946,    F1: 0.6984, AUC:0.9601
```

imbalnced ëœ ë°ì´í„°ì´ê¸° ë•Œë¬¸ì— ëª¨ë¸ì˜ ì¬í˜„ìœ¨ì„ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ë©´ ë˜ëŠ”ë°, ì¬í˜„ìœ¨ì´ ì¡°ê¸ˆ ë‚®ê²Œ ë‚˜ì˜¤ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŒ

ìœ„ì—ì„œ ë§Œë“¤ì–´ ë†“ì€ í‰ê°€ì§€í‘œ í•¨ìˆ˜ì™€ ëª¨ë¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì‘ì—…ì„ í•˜ë‚˜ì˜ í•¨ìˆ˜(get_model_train_eval)ë¡œ í•©ì¹˜ì.

```python
# ì¸ìë¡œ ì‚¬ì´í‚·ëŸ°ì˜ Estimatorê°ì²´ì™€, í•™ìŠµ/í…ŒìŠ¤íŠ¸ ë°ì´í„° ì„¸íŠ¸ë¥¼ ì…ë ¥ ë°›ì•„ì„œ í•™ìŠµ/ì˜ˆì¸¡/í‰ê°€ ìˆ˜í–‰.
def get_model_train_eval(model, ftr_train=None, ftr_test=None, tgt_train=None, tgt_test=None):
    model.fit(ftr_train, tgt_train)
    pred = model.predict(ftr_test)
    pred_proba = model.predict_proba(ftr_test)[:, 1]
    get_clf_eval(tgt_test, pred, pred_proba)
    
```

#####  ëª¨ë¸ ë° í‰ê°€ì§€í‘œ í™•ì¸ (lightGBM)

```python
from lightgbm import LGBMClassifier

lgbm_clf = LGBMClassifier(n_estimators=1000, num_leaves=64, n_jobs=-1, boost_from_average=False)
get_model_train_eval(lgbm_clf, ftr_train=X_train, ftr_test=X_test, tgt_train=y_train, tgt_test=y_test)

```

```
ì˜¤ì°¨ í–‰ë ¬
[[85290     5]
 [   36   112]]
ì •í™•ë„: 0.9995, ì •ë°€ë„: 0.9573, ì¬í˜„ìœ¨: 0.7568,    F1: 0.8453, AUC:0.9790
```

ì¬í˜„ìœ¨ì´ 0.75ë¡œ ë¡œì§€ìŠ¤í‹± ëª¨ë¸ ë³´ë‹¤ëŠ” ë†’ì€ ì„±ëŠ¥ì´ ë‚˜ì™”ìŒ.  ì´ì œ Feature engenieerë¥¼ ì§„í–‰í•œ í›„, ë‹¤ì‹œ ëª¨ë¸ì„ í•™ìŠµí•˜ê³  í‰ê°€ì§€í‘œë¥¼ í™•ì¸í•˜ì.

##### Amount í”¼ì²˜ ê°€ê³µ

```
import seaborn as sns

plt.figure(figsize=(8, 4))
plt.xticks(range(0, 30000, 1000), rotation=60)
sns.distplot(card_df['Amount'])
```

![image](https://user-images.githubusercontent.com/81638919/156914178-0413931d-889f-4a54-a67b-05e0bc860be1.png)


ëŒ€ë¶€ë¶„ì˜ ê¸ˆì•¡ì´ 500ìœ ë¡œ ë¯¸ë§Œì´ì§€ë§Œ, ë‚˜ë¨¸ì§€ í° ê¸ˆì•¡ì´ ì ì§€ë§Œ ì¡´ì¬í•¨. ë”°ë¼ì„œ ê¸´ ê¼¬ë¦¬ë¥¼ ê·¸ë¦¬ëŠ” longtail êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ìˆìŒ. StandardScalerë¥¼ ì´ìš©í•˜ì—¬ í”¼ì²˜ë¥¼ ë³€í™˜í•´ë³´ì.

```python
from sklearn.preprocessing import StandardScaler

# ì‚¬ì´í‚·ëŸ°ì˜ StandardScalerë¥¼ ì´ìš©í•˜ì—¬ ì •ê·œë¶„í¬ í˜•íƒœë¡œ Amount í”¼ì²˜ê°’ ë³€í™˜í•˜ëŠ” ë¡œì§ìœ¼ë¡œ ìˆ˜ì •. 
def get_preprocessed_df(df=None):
    df_copy = df.copy()
    scaler = StandardScaler()
    amount_n = scaler.fit_transform(df_copy['Amount'].values.reshape(-1, 1))
    
    # ë³€í™˜ëœ Amountë¥¼ Amount_Scaledë¡œ í”¼ì²˜ëª… ë³€ê²½í›„ DataFrameë§¨ ì• ì»¬ëŸ¼ìœ¼ë¡œ ì…ë ¥
    df_copy.insert(0, 'Amount_Scaled', amount_n)
    
    # ê¸°ì¡´ Time, Amount í”¼ì²˜ ì‚­ì œ
    df_copy.drop(['Time','Amount'], axis=1, inplace=True)
    return df_copy
```

##### StandardScaler ì§„í–‰ í›„, ëª¨ë¸ ì„±ëŠ¥ í™•ì¸

```python
# Amountë¥¼ ì •ê·œë¶„í¬ í˜•íƒœë¡œ ë³€í™˜ í›„ ë¡œì§€ìŠ¤í‹± íšŒê·€ ë° LightGBM ìˆ˜í–‰. 
X_train, X_test, y_train, y_test = get_train_test_dataset(card_df)

print('### ë¡œì§€ìŠ¤í‹± íšŒê·€ ì˜ˆì¸¡ ì„±ëŠ¥ ###')
lr_clf = LogisticRegression()
get_model_train_eval(lr_clf, ftr_train=X_train, ftr_test=X_test, tgt_train=y_train, tgt_test=y_test)

print('### LightGBM ì˜ˆì¸¡ ì„±ëŠ¥ ###')
lgbm_clf = LGBMClassifier(n_estimators=1000, num_leaves=64, n_jobs=-1, boost_from_average=False)
get_model_train_eval(lgbm_clf, ftr_train=X_train, ftr_test=X_test, tgt_train=y_train, tgt_test=y_test)

```

```
### ë¡œì§€ìŠ¤í‹± íšŒê·€ ì˜ˆì¸¡ ì„±ëŠ¥ ###
ì˜¤ì°¨ í–‰ë ¬
[[85281    14]
 [   58    90]]
ì •í™•ë„: 0.9992, ì •ë°€ë„: 0.8654, ì¬í˜„ìœ¨: 0.6081,    F1: 0.7143, AUC:0.9702
### LightGBM ì˜ˆì¸¡ ì„±ëŠ¥ ###
ì˜¤ì°¨ í–‰ë ¬
[[85290     5]
 [   37   111]]
ì •í™•ë„: 0.9995, ì •ë°€ë„: 0.9569, ì¬í˜„ìœ¨: 0.7500,    F1: 0.8409, AUC:0.9779
```

ì•ì„  ê²°ê³¼ì™€ í¬ê²Œ ë³€í•œê²Œ ì—†ë‹¤. ê·¸ ë‹¤ìŒ Log ë³€í™˜ì„ í•´ë³´ì.

##### Log ë³€í™˜ ë° ì„±ëŠ¥ í™•ì¸

```python
def get_preprocessed_df(df=None):
    df_copy = df.copy()
    # ë„˜íŒŒì´ì˜ log1p( )ë¥¼ ì´ìš©í•˜ì—¬ Amountë¥¼ ë¡œê·¸ ë³€í™˜ 
    amount_n = np.log1p(df_copy['Amount'])
    df_copy.insert(0, 'Amount_Scaled', amount_n)
    df_copy.drop(['Time','Amount'], axis=1, inplace=True)
    return df_copy
```

```python
X_train, X_test, y_train, y_test = get_train_test_dataset(card_df)

print('### ë¡œì§€ìŠ¤í‹± íšŒê·€ ì˜ˆì¸¡ ì„±ëŠ¥ ###')
get_model_train_eval(lr_clf, ftr_train=X_train, ftr_test=X_test, tgt_train=y_train, tgt_test=y_test)

print('### LightGBM ì˜ˆì¸¡ ì„±ëŠ¥ ###')
get_model_train_eval(lgbm_clf, ftr_train=X_train, ftr_test=X_test, tgt_train=y_train, tgt_test=y_test)

```

```
### ë¡œì§€ìŠ¤í‹± íšŒê·€ ì˜ˆì¸¡ ì„±ëŠ¥ ###
ì˜¤ì°¨ í–‰ë ¬
[[85283    12]
 [   59    89]]
ì •í™•ë„: 0.9992, ì •ë°€ë„: 0.8812, ì¬í˜„ìœ¨: 0.6014,    F1: 0.7149, AUC:0.9727
### LightGBM ì˜ˆì¸¡ ì„±ëŠ¥ ###
ì˜¤ì°¨ í–‰ë ¬
[[85290     5]
 [   35   113]]
ì •í™•ë„: 0.9995, ì •ë°€ë„: 0.9576, ì¬í˜„ìœ¨: 0.7635,    F1: 0.8496, AUC:0.9796
```

LightGBMì˜ ì¬í˜„ìœ¨ì´ 0.01 ì •ë„ ë†’ì•„ì§„ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŒ. Amount Skewë˜ì–´ ìˆìœ¼ë©°, ë¡œê·¸ë³€í™˜ì„ í•´ì„œ ìˆ˜í–‰ì„±ëŠ¥ì´ ì¢‹ì•„ì§„ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŒ.

ë‹¤ìŒì—ëŠ” ì´ìƒì¹˜ ì œê±° ë° SMOTE ì˜¤ë²„ ìƒ˜í”Œë§ ì ìš© í›„ ëª¨ë¸ í•™ìŠµ ê·¸ë¦¬ê³  í‰ê°€ë¥¼ í•´ë³´ê² ë‹¤.

