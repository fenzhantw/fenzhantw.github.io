---
title: "[BasicML] Credit Card Fault Detection ì‹¤ìŠµ 02"
excerpt: "Kaggle,Fault Detection,LightGBM"
categories:
    - BasicML

tag:
    - python
    - machine learning

author_profile: true    #ì‘ì„±ì í”„ë¡œí•„ ì¶œë ¥ ì—¬ë¶€

toc: true   #Table Of Contents ëª©ì°¨ 
toc_sticky: true
---

```python
ğŸŒœ ì´ ë¬¸ì„œì— ë‚˜ì˜¤ëŠ” ìë£Œì™€ ë°ì´í„°ëŠ” ê¶Œì² ë¯¼ ì €ì˜ ë¨¸ì‹ ëŸ¬ë‹ ì™„ë²½ê°€ì´ë“œì™€ ì¸í”„ëŸ°ì˜ ê°•ì˜ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì •ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤.
ì˜¤ë¥˜ë‚˜ í‹€ë¦° ë¶€ë¶„ì´ ìˆì„ ê²½ìš° ì–¸ì œë“ ì§€ ëŒ“ê¸€ í˜¹ì€ ë©”ì¼ë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”! ğŸ˜„
```



#### Credit Card Fault Detection ì‹¤ìŠµ 02

- https://www.kaggle.com/mlg-ulb/creditcardfraud

ì¹´ë“œì‚¬ê°€ ì¹´ë“œ ì‚¬ê¸°ê±´ì„ ê²€ì¶œ ë° ë°©ì§€í•˜ëŠ” ê²ƒì€ ê³ ê°ì´ êµ¬ë§¤í•˜ì§€ ì•ŠëŠ” ë¬¼ê±´ì— ëŒ€í•´ ë¹„ìš©ì„ ì§€ë¶ˆí•˜ì§€ ì•Šë„ë¡ í•˜ê¸° ìœ„í•œ ë§¤ìš° ì¤‘ìš”í•œ ì‘ì—…ì„. ë”°ë¼ì„œ ì´ëŸ¬í•œ Faultë¥¼ ê°ì§€í•˜ê¸° ìœ„í•œ ML ëª¨ë¸ì„ ì‹¤ìŠµì„ í†µí•´ êµ¬ì¶•í•´ë³´ê³ , ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•´ë´„



** ê° í”¼ì²˜ë“¤ì˜ ìƒê´€ ê´€ê³„ë¥¼ ì‹œê°í™”. ê²°ì • ë ˆì´ë¸”ì¸ class ê°’ê³¼ ê°€ì¥ ìƒê´€ë„ê°€ ë†’ì€ í”¼ì²˜ ì¶”ì¶œ **

```python
import seaborn as sns

plt.figure(figsize=(9, 9))
corr = card_df.corr()
sns.heatmap(corr, cmap='RdBu')
```

![image](https://user-images.githubusercontent.com/81638919/156915773-e096e05e-1986-409b-a1eb-8d464ae7b799.png)

Classì™€ ë†’ì€ ìƒê´€ê´€ê³„ë¥¼ ê°€ì§„ 'V14' ì»¬ëŸ¼ì„ ê°€ì§€ê³  ì´ìƒì¹˜ ì œê±°ë¥¼ í•´ë³´ë„ë¡ í•˜ì.

ì—¬ê¸°ì„œ ì •ì˜í•œ ì´ìƒì¹˜ëŠ” ì œ1ì‚¬ë¶„ìœ„ìˆ˜ - 1.5IQR, ì œ3ì‚¬ë¶„ìœ„ìˆ˜ + 1.5IQRë¡œ ì •ì˜í•˜ì˜€ê³ , ì´ëŸ¬í•œ ë°ì´í„°ë¥¼ ì°¾ê¸° ìœ„í•œ í•¨ìˆ˜ë¥¼ êµ¬í˜„í•˜ë©´ ì•„ë˜ì™€ ê°™ìŒ

** Dataframeì—ì„œ outlierì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ë¥¼ í•„í„°ë§í•˜ê¸° ìœ„í•œ í•¨ìˆ˜ ìƒì„±. outlier ë ˆì½”ë“œì˜ indexë¥¼ ë°˜í™˜í•¨. **

```python
import numpy as np

def get_outlier(df=None, column=None, weight=1.5):
    # fraudì— í•´ë‹¹í•˜ëŠ” column ë°ì´í„°ë§Œ ì¶”ì¶œ, 1/4 ë¶„ìœ„ì™€ 3/4 ë¶„ìœ„ ì§€ì ì„ np.percentileë¡œ êµ¬í•¨. 
    fraud = df[df['Class']==1][column]
    quantile_25 = np.percentile(fraud.values, 25)
    quantile_75 = np.percentile(fraud.values, 75)
    
    # IQRì„ êµ¬í•˜ê³ , IQRì— 1.5ë¥¼ ê³±í•˜ì—¬ ìµœëŒ€ê°’ê³¼ ìµœì†Œê°’ ì§€ì  êµ¬í•¨. 
    iqr = quantile_75 - quantile_25
    iqr_weight = iqr * weight
    lowest_val = quantile_25 - iqr_weight
    highest_val = quantile_75 + iqr_weight
    
    # ìµœëŒ€ê°’ ë³´ë‹¤ í¬ê±°ë‚˜, ìµœì†Œê°’ ë³´ë‹¤ ì‘ì€ ê°’ì„ ì•„ì›ƒë¼ì´ì–´ë¡œ ì„¤ì •í•˜ê³  DataFrame index ë°˜í™˜. 
    outlier_index = fraud[(fraud < lowest_val) | (fraud > highest_val)].index
    
    return outlier_index
    
```

```python
outlier_index = get_outlier(df=card_df, column='V14', weight=1.5)
print('ì´ìƒì¹˜ ë°ì´í„° ì¸ë±ìŠ¤:', outlier_index)
```

```
ì´ìƒì¹˜ ë°ì´í„° ì¸ë±ìŠ¤: Int64Index([8296, 8615, 9035, 9252], dtype='int64')
```

V12 ì»¬ëŸ¼ì˜ 8296,8615,9035,9252ì— í•´ë‹¹í•˜ëŠ” ì¸ë±ìŠ¤ê°€ ì•ì—ì„œ ì •ì˜í•œ ì´ìƒì¹˜ì— í•´ë‹¹í•¨ì„ í™•ì¸



#### **ë¡œê·¸ ë³€í™˜ í›„ V14 í”¼ì²˜ì˜ ì´ìƒì¹˜ ë°ì´í„°ë¥¼ ì‚­ì œí•œ ë’¤ ëª¨ë¸ë“¤ì„ ì¬ í•™ìŠµ/ì˜ˆì¸¡/í‰ê°€**

```python
# get_processed_df( )ë¥¼ ë¡œê·¸ ë³€í™˜ í›„ V14 í”¼ì²˜ì˜ ì´ìƒì¹˜ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ëŠ” ë¡œì§ìœ¼ë¡œ ë³€ê²½. 
def get_preprocessed_df(df=None):
    df_copy = df.copy()
    amount_n = np.log1p(df_copy['Amount'])
    df_copy.insert(0, 'Amount_Scaled', amount_n)
    df_copy.drop(['Time','Amount'], axis=1, inplace=True)
    
    # ì´ìƒì¹˜ ë°ì´í„° ì‚­ì œí•˜ëŠ” ë¡œì§ ì¶”ê°€
    outlier_index = get_outlier(df=df_copy, column='V14', weight=1.5)
    df_copy.drop(outlier_index, axis=0, inplace=True)
    return df_copy

X_train, X_test, y_train, y_test = get_train_test_dataset(card_df)

print('### ë¡œì§€ìŠ¤í‹± íšŒê·€ ì˜ˆì¸¡ ì„±ëŠ¥ ###')
get_model_train_eval(lr_clf, ftr_train=X_train, ftr_test=X_test, tgt_train=y_train, tgt_test=y_test)

print('### LightGBM ì˜ˆì¸¡ ì„±ëŠ¥ ###')
get_model_train_eval(lgbm_clf, ftr_train=X_train, ftr_test=X_test, tgt_train=y_train, tgt_test=y_test)

```

```
### ë¡œì§€ìŠ¤í‹± íšŒê·€ ì˜ˆì¸¡ ì„±ëŠ¥ ###
ì˜¤ì°¨ í–‰ë ¬
[[85281    14]
 [   48    98]]
ì •í™•ë„: 0.9993, ì •ë°€ë„: 0.8750, ì¬í˜„ìœ¨: 0.6712,    F1: 0.7597, AUC:0.9743
### LightGBM ì˜ˆì¸¡ ì„±ëŠ¥ ###
ì˜¤ì°¨ í–‰ë ¬
[[85290     5]
 [   25   121]]
ì •í™•ë„: 0.9996, ì •ë°€ë„: 0.9603, ì¬í˜„ìœ¨: 0.8288,    F1: 0.8897, AUC:0.9780
```

ê° ëª¨ë¸ë³„ë¡œ ì¬í˜„ìœ¨ì´ ë§ì´ í–¥ìƒëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ë‹¤ìŒì€ SMOTEë¥¼ í™œìš©í•˜ì—¬ ì˜¤ë²„ ìƒ˜í”Œë§ì„ ì ìš©í•˜ì—¬ ëª¨ë¸ì„ í•™ìŠµí•˜ê³  í‰ê°€í•´ë³´ì.



#### SMOTE ì˜¤ë²„ ìƒ˜í”Œë§ ì ìš© í›„ ëª¨ë¸ í•™ìŠµ/ì˜ˆì¸¡/í‰ê°€

```python
from imblearn.over_sampling import SMOTE

smote = SMOTE(random_state=0)
X_train_over, y_train_over = smote.fit_sample(X_train, y_train)
print('SMOTE ì ìš© ì „ í•™ìŠµìš© í”¼ì²˜/ë ˆì´ë¸” ë°ì´í„° ì„¸íŠ¸: ', X_train.shape, y_train.shape)
print('SMOTE ì ìš© í›„ í•™ìŠµìš© í”¼ì²˜/ë ˆì´ë¸” ë°ì´í„° ì„¸íŠ¸: ', X_train_over.shape, y_train_over.shape)
print('SMOTE ì ìš© í›„ ë ˆì´ë¸” ê°’ ë¶„í¬: \n', pd.Series(y_train_over).value_counts())
```

```
SMOTE ì ìš© ì „ í•™ìŠµìš© í”¼ì²˜/ë ˆì´ë¸” ë°ì´í„° ì„¸íŠ¸:  (199362, 29) (199362,)
SMOTE ì ìš© í›„ í•™ìŠµìš© í”¼ì²˜/ë ˆì´ë¸” ë°ì´í„° ì„¸íŠ¸:  (398040, 29) (398040,)
SMOTE ì ìš© í›„ ë ˆì´ë¸” ê°’ ë¶„í¬: 
 0    199020
1    199020
Name: Class, dtype: int64
```

ì´ë¥¼ ê¸°ì¡´ì— y_train.value_counts()í•´ì„œ ì–»ì€ ê°’ê³¼ ë¹„êµí•´ë³´ë©´, í° ì°¨ì´ê°€ ìˆëŠ”ê±¸ í™•ì¸í•  ìˆ˜ ìˆìŒ.

```
0    199020
1       342
Name: Class, dtype: int64
```

ìœ„ ê·¸ë¦¼ê³¼ ê°™ì´ 1(ë¶€ì • ê±°ë˜)ê°’ì´ 0.001ì •ë„ë¡œ ë¶„í¬ë˜ì–´ ìˆì—ˆëŠ”ë°, ì´ë¥¼ ì˜¤ë²„ ìƒ˜í”Œë§ ë°©ë²•ì„ í†µí•´ 0 í´ë˜ìŠ¤ ê°’ê³¼ 1 í´ë˜ìŠ¤ ê°’ì„ ë˜‘ê°™ì´ ë§Œë“¤ì–´ ì¤Œ

ë‹¤ì‹œ ë¡œì§€ìŠ¤í‹± íšŒê·€ë¥¼ í†µí•´ ëª¨ë¸ì„ í‰ê°€í•´ë³´ì. 

```python
lr_clf = LogisticRegression()
# ftr_trainê³¼ tgt_train ì¸ìê°’ì´ SMOTE ì¦ì‹ëœ X_train_overì™€ y_train_overë¡œ ë³€ê²½ë¨ì— ìœ ì˜
get_model_train_eval(lr_clf, ftr_train=X_train_over, ftr_test=X_test, tgt_train=y_train_over, tgt_test=y_test)

```

```
ì˜¤ì°¨ í–‰ë ¬
[[82937  2358]
 [   11   135]]
ì •í™•ë„: 0.9723, ì •ë°€ë„: 0.0542, ì¬í˜„ìœ¨: 0.9247,    F1: 0.1023, AUC:0.9737
```

ì¬í˜„ìœ¨ì„ ë†’ì•„ì¡Œì§€ë§Œ, ì •ë°€ë„ê°€ ë§¤ìš° ë‚®ì•„ì„œ ë¶€ì í•œ ëª¨ë¸ì¸ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŒ. ë°˜ë©´ LightGBMì€ ì–´ë–»ê²Œ ë ê¹Œ?

```python
lgbm_clf = LGBMClassifier(n_estimators=1000, num_leaves=64, n_jobs=-1, boost_from_average=False)
get_model_train_eval(lgbm_clf, ftr_train=X_train_over, ftr_test=X_test,
                  tgt_train=y_train_over, tgt_test=y_test)
```

```
ì˜¤ì°¨ í–‰ë ¬
[[85283    12]
 [   22   124]]
ì •í™•ë„: 0.9996, ì •ë°€ë„: 0.9118, ì¬í˜„ìœ¨: 0.8493,    F1: 0.8794, AUC:0.9814
```

ì•ì„  ëª¨ë¸ë³´ë‹¤ ì •ë°€ë„ëŠ” ë–¨ì–´ì¡Œì§€ë§Œ, ì¬í˜„ìœ¨ì´ ë†’ì•„ì§„ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŒ. ë”°ë¼ì„œ ì¬í˜„ìœ¨ì´ ìƒëŒ€ì ìœ¼ë¡œ ì¤‘ìš”í•œ ëª¨ë¸ì´ì—ˆê¸°ì—, ì •ë°€ë„ë¥¼ ì–´ëŠ ì •ë„ í¬ìƒí•˜ê³  ì¬í˜„ìœ¨ì„ ë†’ì´ëŠ” ì´ˆê¸° ëª©ì ì¸ ë‹¬ì„±ì´ ë˜ì—ˆë‹¤ê³  í•  ìˆ˜ ìˆë‹¤. 

ê°ê°ì˜ ì„±ëŠ¥ì„ ë°ì´í„° ê°€ê³µ ë‹¨ê³„ì— ë”°ë¼ ì •ë¦¬í•´ë³´ì.

#### ìµœì¢… ì •ë¦¬

| ë°ì´í„° ê°€ê³µ        |               | ì •ë°€ë„ | ì¬í˜„ìœ¨ | ROC-AUC |
| ------------------ | ------------- | ------ | ------ | ------- |
| ë°ì´í„° ê°€ê³µ ì—†ìŒ   | ë¡œì§€ìŠ¤í‹± íšŒê·€ | 0.8462 | 0.5946 | 0.9601  |
| ë°ì´í„° ê°€ê³µ ì—†ìŒ   | LightGBM      | 0.9573 | 0.7568 | 0.9790  |
| ë°ì´í„° ë¡œê·¸ ë³€í™˜   | ë¡œì§€ìŠ¤í‹± íšŒê·€ | 0.8812 | 0.6014 | 0.9727  |
| ë°ì´í„° ë¡œê·¸ ë³€í™˜   | LightGBM      | 0.9576 | 0.7635 | 0.9796  |
| ì´ìƒì¹˜ ë°ì´í„° ì œê±° | ë¡œì§€ìŠ¤í‹± íšŒê·€ | 0.8750 | 0.6712 | 0.9743  |
| ì´ìƒì¹˜ ë°ì´í„° ì œê±° | LightGBM      | 0.9603 | 0.8288 | 0.9780  |
| SMOTE ì˜¤ë²„ ìƒ˜í”Œë§  | ë¡œì§€ìŠ¤í‹± íšŒê·€ | 0.0542 | 0.9247 | 0.9737  |
| SMOTE ì˜¤ë²„ ìƒ˜í”Œë§  | LightGBM      | 0.9118 | 0.8493 | 0.9814  |



ì´ˆê¸° ë°ì´í„° ê°€ê³µì´ ì—†ì—ˆì„ë•Œì™€ ëª¨ë¸ì˜ ì„±ëŠ¥ê³¼ ë¹„êµí•˜ì˜€ì„ ë•Œ, ë°ì´í„° ê°€ê³µì˜ íš¨ê³¼ëŠ” í¬ë‹¤ê³  ë§í•  ìˆ˜ ìˆë‹¤. íŠ¹íˆ ì´ìƒì¹˜ ë°ì´í„° ì œê±°ë¥¼ í†µí•´ ì¬í˜„ìœ¨ì„ ë†’ì¼ ìˆ˜ ìˆì—ˆìœ¼ë©°, ì´ë¥¼ í†µí•´ ì´ìƒì¹˜ ì œê±°ëŠ” ëª¨ë¸ì˜ ì„±ëŠ¥ì„ ì¢‹ê²Œ ë§Œë“œëŠ” ê²ƒì˜ ê¸°ì´ˆë¼ê³  ìƒê°ì´ ëœë‹¤.

ë‹¤ìŒì—ëŠ” ëª¨ë¸ì„ ìŒ“ì•„ ì„±ëŠ¥ì„ ë†’ì´ëŠ” ìŠ¤íƒœí‚¹ ëª¨ë¸ì— ëŒ€í•´ì„œ ë°°ì›Œë³´ë„ë¡ í•œë‹¤.

